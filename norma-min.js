/* Copyright (c) 2014-2015 Richard Rodger, MIT License */
"use strict";var util=require("util"),_={};_.isNaN=require("lodash.isnan"),_.isRegExp=require("lodash.isregexp"),_.isDate=require("lodash.isdate"),_.isArguments=require("lodash.isarguments");var error=require("eraro")({package:"norma"}),parser=require("./norma-parser"),defopts={onfail:"throw",desclen:33},specmap={};function compile(e){if(null==e)throw error("no_spec","no argument specification");var r=specmap[e];if(null!=r)return r;var s=parse_spec(e),n=[],t=1,o=["^"],p=0;s.forEach(function(e){if(o.push("("),e.type.or&&0<e.type.or.length){var r=1;o.push("("),o.push(e.type.mark),o.push(")"),e.type.or.forEach(function(e){o.push("|"),o.push("("),o.push(e[1]),r++,o.push(")")}),"?"==e.mod&&o.push("|[UNA]?"),n[p]={index:t},t+=r}else"?"==e.mod?o.push("[UNA"+e.type.mark+"]?"):(o.push(e.type.mark),o.push(e.mod||"")),n[p]={index:t};n[p].mod=e.mod,o.push(")"),t++,p++}),o.push("$");var i=new RegExp(o.join(""));return r=specmap[e]={re:i,spec:e,respec:s,reindex:n}}function parse_spec(r){try{return parser.parse(r)}catch(e){throw error("parse",e.message+'; spec:"'+r+'", col:'+e.location.start.column+", line:"+e.location.start.line)}}function processargs(e,r,s){var n=Array.prototype.slice.call(s||[]),t=describe(n),o=e.re.exec(t);if(!o){if("throw"==r.onfail)throw error("invalid_arguments",'invalid arguments; expected: "'+e.spec+'", was: ['+t+"]; values: "+descargs(n,r),{args:n,specdef:e,options:r});return null}for(var p=e.respec.object?{}:[],i=0,u=0,a=0;i<e.reindex.length;i++){var c=e.reindex[i],l=void 0;if(e.respec.object||(p[a]=l),null!=c.index){var h=o[c.index];if(""!==h){var d=e.respec[i].name,f="*"===e.respec[i].mod,m="+"===e.respec[i].mod;if(0===h.length&&m)throw error("invalid_arguments",'invalid arguments; expected: "'+e.spec+'", was: ['+t+"]; values: "+descargs(n,r),{args:n,specdef:e,options:r});if(1==h.length)l=n[u],u++,e.respec.object||(p[a]=l),null!=d&&(f||m?(p[d]=p[d]||[]).push(l):p[e.respec[i].name]=l),a++;else if(1<h.length)for(var g=0;g<h.length;g++)l=n[u],u++,e.respec.object||(p[a]=l),null!=d&&(p[d]=p[d]||[]).push(l),a++}else e.respec.object||(p[a]=void 0),a++}}return p}function describe(e){var r=[];return e.forEach(function(e){"string"==typeof e?r.push("s"):isNaN(e)||(0|e)!==parseFloat(e)?_.isNaN(e)?r.push("A"):1/0===e?r.push("Y"):"number"==typeof e?r.push("n"):"boolean"==typeof e?r.push("b"):"function"==typeof e?r.push("f"):Array.isArray(e)?r.push("a"):_.isRegExp(e)?r.push("r"):_.isDate(e)?r.push("d"):_.isArguments(e)?r.push("g"):util.isError(e)?r.push("e"):null===e?r.push("N"):void 0===e?r.push("U"):"object"==typeof e?r.push("o"):r.push("q"):r.push("i")}),r.join("")}function descargs(e,s){var n=[];return e.forEach(function(e){var r=util.inspect(e).substring(0,s.desclen);n.push(r)}),n}function handle(e,r,s){if((_.isArguments(r)||Array.isArray(r))&&(s=r,r=null),r=null==r?defopts:Object.assign({},defopts,r),null==s)throw error("init",'no arguments variable; expected norma( "...", arguments ), '+"or <compiled>( arguments )",{arguments:arguments});return processargs(e,r,s)}module.exports=function(e,r,s){return handle(compile(e),r,s)},module.exports.compile=function(e){function r(e,r){return handle(s,e,r)}var s=compile(e);return r.toString=function(){return util.inspect({spec:s.spec,re:""+s.re})},r};